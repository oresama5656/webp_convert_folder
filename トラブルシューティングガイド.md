# WebP自動変換システム トラブルシューティングガイド

## 共通の確認事項

### 1. ログファイルの確認
まず最初にログファイルを確認してください：

```powershell
# ログフォルダを開く
explorer "$env:LOCALAPPDATA\\WebP-Auto\\logs"

# 最新のログファイルを表示
Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\logs\\$(Get-Date -Format 'yyyy-MM-dd').log" -Tail 20
```

### 2. タスクの実行状態確認
```powershell
# タスクの状態確認
Get-ScheduledTask -TaskName "WebP Auto Converter" | Select-Object TaskName, State

# タスクの詳細情報
Get-ScheduledTaskInfo -TaskName "WebP Auto Converter"
```

## よくある問題と解決方法

### 問題1: スクリプトが開始しない

#### 症状
- タスクスケジューラで実行しているのにプロセスが見つからない
- ログファイルが作成されない

#### 確認事項
```powershell
# 実行ポリシーの確認
Get-ExecutionPolicy -Scope CurrentUser
```

#### 解決方法
```powershell
# 実行ポリシーを設定
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# タスクを再登録
.\\Install-TaskScheduler.ps1 -Uninstall
.\\Install-TaskScheduler.ps1
```

### 問題2: 変換ツールが見つからない

#### 症状
- ログに "ImageMagickまたはcwebpが必要です" というエラー
- "変換ツールが見つかりません" エラー

#### 確認事項
```cmd
# コマンドプロンプトで確認
magick -version
cwebp -version
```

#### 解決方法（ImageMagick）
1. 環境変数PATHにImageMagickのパスが含まれているか確認
2. ImageMagickを再インストール
3. PowerShellを再起動してパスを再読み込み

```powershell
# パスの確認
$env:PATH -split ';' | Where-Object { $_ -like '*ImageMagick*' }

# 手動でパスを追加（一時的）
$env:PATH += ";C:\\Program Files\\ImageMagick-7.1.1-Q16-HDRI"
```

#### 解決方法（cwebp）
1. WebP toolsをダウンロードして適切なフォルダに配置
2. 環境変数PATHに追加
3. コマンドプロンプトで動作確認

### 問題3: ファイルが変換されない

#### 症状
- ファイルを保存してもWebPファイルが作成されない
- ログに "重複処理をスキップしました" が表示される

#### 確認事項
```powershell
# 設定ファイルの確認
Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\config.json" | ConvertFrom-Json
```

#### 解決方法
1. 監視フォルダの設定確認
2. ファイル拡張子の確認（対応: .png, .jpg, .jpeg, .bmp）
3. 除外パターンの確認

```json
{
  "WatchPaths": ["C:\\Users\\[ユーザー名]\\Downloads"],
  "SupportedExtensions": [".png", ".jpg", ".jpeg", ".bmp"],
  "ExcludePatterns": []
}
```

### 問題4: アクセス拒否エラー

#### 症状
- "ファイルがロックされているため処理をスキップしました"
- "アクセスが拒否されました" エラー

#### 解決方法
1. ファイルが他のプログラムで開かれていないか確認
2. ウイルス対策ソフトがファイルをスキャン中でないか確認
3. 管理者権限でのテスト実行

```powershell
# 管理者権限でPowerShellを開いてテスト
.\\WebP-AutoConverter.ps1 -OneTime
```

### 問題5: 長いファイルパスエラー

#### 症状
- "The specified path, file name, or both are too long"
- ファイルパスが260文字を超える場合のエラー

#### 解決方法
スクリプトは自動的に長いパス（`\\?\`プレフィックス）に対応していますが、問題が続く場合：

1. Windows 10/11で長いパス名サポートを有効化
2. レジストリエディタで以下を設定：
   ```
   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem
   LongPathsEnabled = 1 (DWORD)
   ```

### 問題6: 通知が表示されない

#### 症状
- エラー発生時に通知が表示されない
- BurntToastが機能しない

#### 確認事項
```powershell
# BurntToastモジュールの確認
Get-Module -ListAvailable -Name BurntToast
```

#### 解決方法
```powershell
# BurntToastモジュールをインストール
Install-Module -Name BurntToast -Scope CurrentUser

# 通知設定を確認
$config = Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\config.json" | ConvertFrom-Json
$config.EnableNotifications
```

### 問題7: メモリ不足

#### 症状
- 大量のファイル処理時にスクリプトが停止
- "System.OutOfMemoryException"

#### 解決方法
1. 処理遅延時間を増加
2. 同時処理ファイル数を制限

```json
{
  "ProcessDelayMs": 2000,
  "PreventDuplicateProcessing": true
}
```

### 問題8: タスクスケジューラでの実行エラー

#### 症状
- タスクスケジューラでは失敗するが手動では成功する
- タスクの最後の実行結果が0x1など

#### 解決方法
```powershell
# タスクの実行ユーザーを確認
Get-ScheduledTask -TaskName "WebP Auto Converter" | Select-Object -ExpandProperty Principal

# 現在のユーザーで再登録
.\\Install-TaskScheduler.ps1 -Uninstall
.\\Install-TaskScheduler.ps1
```

### 問題9: 設定ファイルが読み込まれない

#### 症状
- 設定変更が反映されない
- デフォルト設定で動作してしまう

#### 解決方法
```powershell
# 設定ファイルの文法チェック
try {
  Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\config.json" | ConvertFrom-Json
  Write-Host "設定ファイルは正常です"
} catch {
  Write-Host "設定ファイルにエラーがあります: $($_.Exception.Message)"
}

# 設定ファイルを再作成
Remove-Item "$env:LOCALAPPDATA\\WebP-Auto\\config.json"
.\\WebP-AutoConverter.ps1 -OneTime  # デフォルト設定を生成
```

## デバッグ用コマンド

### ログレベルを詳細に設定
```json
{
  "LogLevel": "DEBUG"
}
```

### 手動でのファイル変換テスト
```powershell
# ImageMagickでのテスト
magick "test.png" -quality 95 "test.webp"

# cwebpでのテスト
cwebp -q 95 "test.jpg" -o "test.webp"
```

### 監視フォルダの権限確認
```powershell
# フォルダの権限確認
Get-Acl "C:\\Users\\$env:USERNAME\\Downloads" | Format-List

# 書き込み権限のテスト
New-Item -Path "C:\\Users\\$env:USERNAME\\Downloads\\test.txt" -ItemType File -Force
Remove-Item -Path "C:\\Users\\$env:USERNAME\\Downloads\\test.txt" -Force
```

## パフォーマンス最適化

### 1. 処理の高速化
```json
{
  "ProcessDelayMs": 500,
  "PreventDuplicateProcessing": true
}
```

### 2. ログサイズの管理
定期的に古いログファイルを削除：
```powershell
# 30日以上古いログを削除
Get-ChildItem "$env:LOCALAPPDATA\\WebP-Auto\\logs\\*.log" | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-30) } | Remove-Item
```

## サポート情報の収集

問題の報告時には以下の情報を収集してください：

```powershell
# システム情報
Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory

# PowerShellバージョン
$PSVersionTable

# 実行ポリシー
Get-ExecutionPolicy -List

# 変換ツールのバージョン
magick -version
cwebp -version

# 設定ファイル
Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\config.json"

# 最新のログ（最後の50行）
Get-Content "$env:LOCALAPPDATA\\WebP-Auto\\logs\\$(Get-Date -Format 'yyyy-MM-dd').log" -Tail 50
```

これらの情報と具体的なエラーメッセージがあれば、問題の特定と解決が容易になります。